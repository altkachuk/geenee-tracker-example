var t,e=(t=require("@geenee/geenee-tracking-impl"))&&"object"==typeof t&&"default"in t?t.default:t;class r{constructor(){this.timeStart=null,this.nLastElapsedMs=0,this.nTotalElapsedMs=0,this.nTotalTimes=0}setMeasurementStart(){this.timeStart=new Date}setMeasurementEnd(){var t=new Date;this.nLastElapsedMs=t-this.timeStart,this.nTotalElapsedMs+=this.nLastElapsedMs,this.nTotalTimes++}getLastElapsedMs(){return this.nLastElapsedMs}getAvgElapsedMs(){return this.nTotalTimes>0?this.nTotalElapsedMs/this.nTotalTimes:0}}const a=require("events");window.GeeneeTracking=class extends a{constructor(t){super(),this.runningRecognition=!1,this.runningVerification=!1,this.wasm_api={create_buffer:e.cwrap("create_buffer","number",["number","number"]),create_rototranslation_buffer:e.cwrap("create_rototranslation_buffer","number"),create_camera_matrix_buffer:e.cwrap("create_camera_matrix_buffer","number"),destroy_buffer:e.cwrap("destroy_buffer","",["number"]),load_target:e.cwrap("load_target","number",["number"]),draw_recognition_result:e.cwrap("draw_recognition_result","",["number","number","number","number"]),get_report:e.cwrap("get_report","string",["number","number"]),is_tracking:e.cwrap("is_tracking","number",[]),get_AR_update:e.cwrap("get_AR_update","number",["number","number","number"]),train:e.cwrap("train","",[]),verify_tracking:e.cwrap("verify_tracking","",[])},this.debugLevel=0,this.debugLevel>0&&(this.loadingStats=new r,this.processingStats=new r,this.visualizationStats=new r,this.totalStats=new r,this.loadGrountruth(t)),this.targetID=-1,this.focal=-1}report(t,r){try{var a;this.loadingStats.getAvgElapsedMs().toFixed(1);if("<br>Processing time avg [ms]: "+this.processingStats.getAvgElapsedMs().toFixed(1),"<br>Visualization time avg [ms]: "+this.visualizationStats.getAvgElapsedMs().toFixed(1),"<br>Total time avg [ms]: "+this.totalStats.getAvgElapsedMs().toFixed(1),1==r&&void 0!==this.groundtruth.results){this.groundtruth.resultsIdx=0|Math.ceil(t*this.groundtruth.fps);const r=new Float64Array(this.groundtruth.results[this.groundtruth.resultsIdx].homography);e.HEAPF64.set(r,this.groundtruth.homographyPtr/8),a=this.wasm_api.get_report(this.homographyPtr,this.groundtruth.homographyPtr)}else a=this.wasm_api.get_report();document.getElementById(this.wasm_api.is_tracking()?"report_tracking_details":"report_detection_details").innerHTML=a}catch(t){}}loadTarget(t){try{const r=this.wasm_api.create_buffer(t.width,t.height);e.HEAP8.set(t.data,r);this.wasm_api.load_target(r);this.wasm_api.destroy_buffer(r)}catch(t){document.getElementById("status").innerHTML=t+t.stack}}train(){this.wasm_api.train(),window.dispatchEvent(new Event("geenee-recognition-trained"))}loadGrountruth(t){this.groundtruth={},void 0!==t&&(this.groundtruth.results=t.recognition_results,this.groundtruth.fps=t.fps,this.groundtruth.resultsIdx=0)}init(t,e){t&&e&&(this.queryPtr=this.wasm_api.create_buffer(t,e),this.rototranslationPtr=this.wasm_api.create_rototranslation_buffer(),this.camMatrixPtr=this.wasm_api.create_camera_matrix_buffer(),window.dispatchEvent(new Event("geenee-recognition-initialized")))}verifyTracking(){var t=this;setImmediate((function(){!1===t.runningVerification&&(t.runningVerification=!0,t.wasm_api.verify_tracking(),t.runningVerification=!1)}))}recognize(t,r){var a=this;setImmediate((function(){if(!1===a.runningRecognition){var i;a.runningRecognition=!0;var s=null,n=-1;if(0===a.debugLevel)e.HEAP8.set(t.data,a.queryPtr),-1!==(n=a.wasm_api.get_AR_update(a.queryPtr,a.camMatrixPtr,a.rototranslationPtr))&&(i=new Float64Array(e.HEAPF64.buffer,a.rototranslationPtr,16),s=new Float64Array(e.HEAPF64.buffer,a.camMatrixPtr,12));else{if(a.totalStats.setMeasurementStart(),a.loadingStats.setMeasurementStart(),e.HEAP8.set(t.data,a.queryPtr),a.loadingStats.setMeasurementEnd(),a.processingStats.setMeasurementStart(),n=a.wasm_api.get_AR_update(a.queryPtr,a.camMatrixPtr,a.rototranslationPtr),a.processingStats.setMeasurementEnd(),a.visualizationStats.setMeasurementStart(),-1===n);else if(i=new Float64Array(e.HEAPF64.buffer,a.rototranslationPtr,16),s=new Float64Array(e.HEAPF64.buffer,a.camMatrixPtr,12),a.debugLevel>1){a.wasm_api.draw_recognition_result(n,a.queryPtr,a.camMatrixPtr,a.rototranslationPtr);const r=new Uint8Array(e.HEAP8.buffer,a.queryPtr,4*t.width*t.height);for(var o=0;o<r.length;o+=4)t.data[o]=r[o],t.data[o+1]=r[o+1],t.data[o+2]=r[o+2],t.data[o+3]=255}a.visualizationStats.setMeasurementEnd(),a.totalStats.setMeasurementEnd(),a.report(r,n)}a.runningRecognition=!1,a.targetID=n,s&&(a.focal=s[5]),a.emit("geenee-tracker-update",i,t)}}))}getTargetID(){return this.targetID}getFocal(){return this.focal}};let i=window.GeeneeTracking;module.exports=i;
