import _defineProperty from"@babel/runtime/helpers/defineProperty";import{Quaternion,Vector3,Euler}from"three";var enterModule;enterModule="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.enterModule:void 0,enterModule&&enterModule(module);var __signature__="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default.signature:function(e){return e};const getEmitter=function(e=null){const t=Object.create({all:[]});return{on:function(e,o){const r=t[e]||[];-1===r.indexOf(o)&&r.push(o),t[e]=r},off:function(e,o){const r=t[e]||[];if("function"==typeof o){const e=r.indexOf(o);e>-1&&r.splice(e,1)}else r.length=0;"all"!==e&&0===r.length&&delete t[e]},emit:function(o,...r){if((t[o]||[]).map((function(t){return t.apply(e,r)})),t.all.length>0){const n=[o,...r];t.all.map((function(t){return t.apply(e,n)}))}},getLength:function(e){return(t[e]||[]).length}}},_default=getEmitter;var reactHotLoader,leaveModule;reactHotLoader="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default:void 0,reactHotLoader&&(reactHotLoader.register(getEmitter,"getEmitter","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\emitter\\getEmitter.js"),reactHotLoader.register(_default,"default","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\emitter\\getEmitter.js")),leaveModule="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.leaveModule:void 0,leaveModule&&leaveModule(module),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.enterModule:void 0;e&&e(module)}();var __signature__$1="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default.signature:function(e){return e};class SensorSample{constructor(e,t){this.set(e,t)}set(e,t){this.sample=e,this.timestampS=t}copy(e){this.set(e.sample,e.timestampS)}__reactstandin__regenerateByEval(key,code){this[key]=eval(code)}}!function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default:void 0;e&&e.register(SensorSample,"SensorSample","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\SensorSample.js")}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.leaveModule:void 0;e&&e(module)}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.enterModule:void 0;e&&e(module)}();var __signature__$2="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default.signature:function(e){return e};const MIN_TIMESTEP=.001,MAX_TIMESTEP=1,isIOS=function(){return/iPad|iPhone|iPod/.test(navigator.platform)},isAndroid=function(){return-1!==navigator.userAgent.indexOf("Android")},isR7=function(){return-1!==navigator.userAgent.indexOf("R7 Build")},isLandscapeMode=function(){const e=90===window.orientation||-90===window.orientation;return isR7()?!e:e},isTimestampDeltaValid=function(e){return!isNaN(e)&&(!(e<=MIN_TIMESTEP)&&!(e>MAX_TIMESTEP))},isFirefoxAndroid=function(){return-1!==navigator.userAgent.indexOf("Firefox")&&-1!==navigator.userAgent.indexOf("Android")},getChromeVersion=function(){const e=navigator.userAgent.match(/.*Chrome\/([0-9]+)/);return e?parseInt(e[1],10):null},slicedToArray=function(e,t){let o=[],r=!0,n=!1,i=void 0;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done)&&(o.push(a.value),!t||o.length!==t);r=!0);}catch(e){n=!0,i=e}finally{try{!r&&s.return&&s.return()}finally{if(n)throw i}}return o},isChromeWithoutDeviceMotion=function(){let e=!1;if(65===getChromeVersion()){const t=navigator.userAgent.match(/.*Chrome\/([0-9\.]*)/);if(t){let o=t[1].split("."),r=slicedToArray(o,4),n=r[2],i=r[3];e=3325===parseInt(n,10)&&parseInt(i,10)<148}}return e},getOriginFromUrl=function(e){let t,o=e.indexOf("://");t=-1!==o?o+3:0;let r=e.indexOf("/",t);return-1===r&&(r=e.length),e.substring(0,r)},isInsideCrossOriginIFrame=function(){const e=window.self!==window.top,t=getOriginFromUrl(document.referrer),o=getOriginFromUrl(window.location.href);return e&&t!==o};!function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default:void 0;e&&(e.register(MIN_TIMESTEP,"MIN_TIMESTEP","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\util.js"),e.register(MAX_TIMESTEP,"MAX_TIMESTEP","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\util.js"),e.register(isIOS,"isIOS","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\util.js"),e.register(isAndroid,"isAndroid","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\util.js"),e.register(isR7,"isR7","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\util.js"),e.register(isLandscapeMode,"isLandscapeMode","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\util.js"),e.register(isTimestampDeltaValid,"isTimestampDeltaValid","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\util.js"),e.register(isFirefoxAndroid,"isFirefoxAndroid","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\util.js"),e.register(getChromeVersion,"getChromeVersion","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\util.js"),e.register(slicedToArray,"slicedToArray","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\util.js"),e.register(isChromeWithoutDeviceMotion,"isChromeWithoutDeviceMotion","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\util.js"),e.register(getOriginFromUrl,"getOriginFromUrl","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\util.js"),e.register(isInsideCrossOriginIFrame,"isInsideCrossOriginIFrame","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\util.js"))}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.leaveModule:void 0;e&&e(module)}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.enterModule:void 0;e&&e(module)}();var __signature__$3="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default.signature:function(e){return e};class ComplementaryFilter{constructor(e){this.kFilter=e,this.filterQ=new Quaternion(isIOS()?-1:1,0,0,1),this.accelQ=new Quaternion,this.isOrientationInitialized=!1,this.estimatedGravity=new Vector3,this.measuredGravity=new Vector3,this.gyroIntegralQ=new Quaternion,this.previousFilterQ=new Quaternion,this.currentAccelMeasurement=new SensorSample,this.currentGyroMeasurement=new SensorSample,this.previousGyroMeasurement=new SensorSample,this.previousFilterQ.copy(this.filterQ)}getOrientation(){return this.filterQ}addAccelMeasurement(e,t){this.currentAccelMeasurement.set(e,t)}addGyroMeasurement(e,t){this.currentGyroMeasurement.set(e,t);const o=t-this.previousGyroMeasurement.timestampS;isTimestampDeltaValid(o)&&this.run(),this.previousGyroMeasurement.copy(this.currentGyroMeasurement)}run(){if(!this.isOrientationInitialized)return this.accelQ=this.accelToQuaternion(this.currentAccelMeasurement.sample),this.previousFilterQ.copy(this.accelQ),void(this.isOrientationInitialized=!0);const e=this.currentGyroMeasurement.timestampS-this.previousGyroMeasurement.timestampS,t=this.gyroToQuaternionDelta(this.currentGyroMeasurement.sample,e);this.gyroIntegralQ.multiply(t),this.filterQ.copy(this.previousFilterQ),this.filterQ.multiply(t);const o=new Quaternion;o.copy(this.filterQ),o.inverse(),this.estimatedGravity.set(0,0,-1),this.estimatedGravity.applyQuaternion(o),this.estimatedGravity.normalize(),this.measuredGravity.copy(this.currentAccelMeasurement.sample),this.measuredGravity.normalize();const r=new Quaternion;r.setFromUnitVectors(this.estimatedGravity,this.measuredGravity),r.inverse();const n=new Quaternion;n.copy(this.filterQ),n.multiply(r),this.filterQ.slerp(n,1-this.kFilter),this.previousFilterQ.copy(this.filterQ)}accelToQuaternion(e){const t=new Vector3;t.copy(e),t.normalize();const o=new Quaternion;return o.setFromUnitVectors(new Vector3(0,0,-1),t),o.inverse(),o}gyroToQuaternionDelta(e,t){const o=new Quaternion,r=new Vector3;return r.copy(e),r.normalize(),o.setFromAxisAngle(r,e.length()*t),o}__reactstandin__regenerateByEval(key,code){this[key]=eval(code)}}!function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default:void 0;e&&e.register(ComplementaryFilter,"ComplementaryFilter","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\ComplementaryFilter.js")}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.leaveModule:void 0;e&&e(module)}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.enterModule:void 0;e&&e(module)}();var __signature__$4="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default.signature:function(e){return e};class PosePredictor{constructor(e){this.predictionTimeS=e,this.previousQ=new Quaternion,this.deltaQ=new Quaternion,this.outQ=new Quaternion,this.previousTimestampS=null}getPrediction(e,t,o){if(null===this.previousTimestampS)return this.previousQ.copy(e),this.previousTimestampS=o,e;const r=new Vector3;r.copy(t),r.normalize();const n=t.length();if(n<20*Math.PI/180)return this.outQ.copy(e),this.previousQ.copy(e),this.outQ;this.previousTimestampS;const i=n*this.predictionTimeS;return this.deltaQ.setFromAxisAngle(r,i),this.outQ.copy(this.previousQ),this.outQ.multiply(this.deltaQ),this.previousQ.copy(e),this.previousTimestampS=o,this.outQ}__reactstandin__regenerateByEval(key,code){this[key]=eval(code)}}!function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default:void 0;e&&e.register(PosePredictor,"PosePredictor","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\PosePredictor.js")}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.leaveModule:void 0;e&&e(module)}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.enterModule:void 0;e&&e(module)}();var __signature__$5="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default.signature:function(e){return e};const DEFAULT_SETTINGS={isFirefoxAndroid:isFirefoxAndroid(),isIOS:isIOS(),chromeVersion:getChromeVersion(),isWithoutDeviceMotion:isChromeWithoutDeviceMotion(),isInsideCrossOriginIFrame:isInsideCrossOriginIFrame(),isR7:isR7()};class FusionPoseSensor{constructor(e,t,o,r){var n=this;_defineProperty(this,"onOrientationChange",(function(e){n.setScreenTransform()})),_defineProperty(this,"onDeviceOrientation",(function(e){n._deviceOrientationQ=n._deviceOrientationQ||new Quaternion;let t=e.alpha,o=e.beta,r=e.gamma;t=(t||0)*Math.PI/180,o=(o||0)*Math.PI/180,r=(r||0)*Math.PI/180;const i=new Euler(o,t,-r,"XYZ");n._deviceOrientationQ.setFromEuler(i)})),_defineProperty(this,"onDeviceMotion",(function(e){n.updateDeviceMotion(e)})),_defineProperty(this,"onMessage",(function(e){const t=e.data;if(!t||!t.type)return;"devicemotion"===t.type.toLowerCase()&&n.updateDeviceMotion(t.deviceMotionEvent)})),this.yawOnly=o,this.accelerometer=new Vector3,this.gyroscope=new Vector3,this.filter=new ComplementaryFilter(e),this.posePredictor=new PosePredictor(t),this.settings=DEFAULT_SETTINGS,this.settings.isDeviceMotionInRadians=r,this.filterToWorldQ=new Quaternion,this.settings.isIOS?this.filterToWorldQ.setFromAxisAngle(new Vector3(1,0,0),Math.PI/2):this.filterToWorldQ.setFromAxisAngle(new Vector3(1,0,0),-Math.PI/2),this.inverseWorldToScreenQ=new Quaternion,this.worldToScreenQ=new Quaternion,this.originalPoseAdjustQ=new Quaternion,this.originalPoseAdjustQ.setFromAxisAngle(new Vector3(0,0,1),-window.orientation*Math.PI/180),this.setScreenTransform(),isLandscapeMode()&&this.filterToWorldQ.multiply(this.inverseWorldToScreenQ),this.resetQ=new Quaternion,this.orientationOut_=new Float32Array(4),this.start()}getOrientation(){let e=null;if(this.settings.isWithoutDeviceMotion&&this._deviceOrientationQ){this.deviceOrientationFixQ=this.deviceOrientationFixQ||function(){let e=(new Quaternion).setFromAxisAngle(new Vector3(0,0,-1),0),t=new Quaternion;return-90===window.orientation?t.setFromAxisAngle(new Vector3(0,1,0),Math.PI/-2):t.setFromAxisAngle(new Vector3(0,1,0),Math.PI/2),e.multiply(t)}(),this.deviceOrientationFilterToWorldQ=this.deviceOrientationFilterToWorldQ||function(){let e=new Quaternion;return e.setFromAxisAngle(new Vector3(1,0,0),-Math.PI/2),e}(),e=this._deviceOrientationQ;let t=new Quaternion;return t.copy(e),t.multiply(this.deviceOrientationFilterToWorldQ),t.multiply(this.resetQ),t.multiply(this.worldToScreenQ),t.multiplyQuaternions(this.deviceOrientationFixQ,t),this.yawOnly&&(t.x=0,t.z=0,t.normalize()),this.orientationOut_[0]=t.x,this.orientationOut_[1]=t.y,this.orientationOut_[2]=t.z,this.orientationOut_[3]=t.w,this.orientationOut_}{let t=this.filter.getOrientation();e=this.posePredictor.getPrediction(t,this.gyroscope,this.previousTimestampS)}let t=new Quaternion;return t.copy(this.filterToWorldQ),t.multiply(this.resetQ),t.multiply(e),t.multiply(this.worldToScreenQ),this.yawOnly&&(t.x=0,t.z=0,t.normalize()),this.orientationOut_[0]=t.x,this.orientationOut_[1]=t.y,this.orientationOut_[2]=t.z,this.orientationOut_[3]=t.w,this.orientationOut_}resetPose(){this.resetQ.copy(this.filter.getOrientation()),this.resetQ.x=0,this.resetQ.y=0,this.resetQ.z*=-1,this.resetQ.normalize(),isLandscapeMode()&&this.resetQ.multiply(this.inverseWorldToScreenQ),this.resetQ.multiply(this.originalPoseAdjustQ)}updateDeviceMotion(e){const t=e.accelerationIncludingGravity,o=e.rotationRate,r=e.timeStamp/1e3,n=r-this.previousTimestampS;n<0||n<=MIN_TIMESTEP||n>MAX_TIMESTEP||(this.accelerometer.set(-t.x,-t.y,-t.z),this.settings.isR7?this.gyroscope.set(-o.beta,o.alpha,o.gamma):this.gyroscope.set(o.alpha,o.beta,o.gamma),this.settings.isDeviceMotionInRadians||this.gyroscope.multiplyScalar(Math.PI/180),this.filter.addAccelMeasurement(this.accelerometer,r),this.filter.addGyroMeasurement(this.gyroscope,r)),this.previousTimestampS=r}setScreenTransform(){switch(this.worldToScreenQ.set(0,0,0,1),window.orientation){case 90:this.worldToScreenQ.setFromAxisAngle(new Vector3(0,0,1),-Math.PI/2);case-90:this.worldToScreenQ.setFromAxisAngle(new Vector3(0,0,1),Math.PI/2)}this.inverseWorldToScreenQ.copy(this.worldToScreenQ),this.inverseWorldToScreenQ.inverse()}start(){var e=this;this.settings.isIOS&&this.settings.isInsideCrossOriginIFrame&&window.addEventListener("message",this.onMessage),window.addEventListener("orientationchange",this.onOrientationChange),this.settings.isWithoutDeviceMotion?window.addEventListener("deviceorientation",this.onDeviceOrientation):this.settings.isIOS?DeviceMotionEvent.requestPermission().then((function(t){"granted"===t&&window.addEventListener("devicemotion",e.onDeviceMotion)})):window.addEventListener("devicemotion",this.onDeviceMotion)}stop(){window.removeEventListener("devicemotion",this.onDeviceMotion),window.removeEventListener("deviceorientation",this.onDeviceOrientation),window.removeEventListener("orientationchange",this.onOrientationChange),window.removeEventListener("message",this.onMessage)}__reactstandin__regenerateByEval(key,code){this[key]=eval(code)}}!function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default:void 0;e&&(e.register(DEFAULT_SETTINGS,"DEFAULT_SETTINGS","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\FusionPoseSensor.js"),e.register(FusionPoseSensor,"FusionPoseSensor","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\FusionPoseSensor.js"))}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.leaveModule:void 0;e&&e(module)}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.enterModule:void 0;e&&e(module)}();var __signature__$6="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default.signature:function(e){return e};class PoseSensor{constructor(e){var t=this;_defineProperty(this,"onOrientationChange",(function(e){t.fusionSensor.setScreenTransform()})),this.updateCallback=e,this.isIOS=isIOS(),this.isDeviceMotionInRadians=!this.isIOS&&getChromeVersion()&&getChromeVersion()<66,this.isInsideCrossOriginIFrame=isInsideCrossOriginIFrame(),this.started=!1,this.events=[],this.timestamps=[],this.linear_accelerations=[],this.last_timestamp=0,this.timer=null}startTimer(){var e=this;this.timer=requestAnimationFrame((function(){return e.onFrame()}))}clearTimer(){cancelAnimationFrame(this.timer)}onFrame(){var e=this;this.timer=requestAnimationFrame((function(){return e.onFrame()}))}async onDeviceMotion(e){this.pushDeviceMotionEvent(e)}pushDeviceMotionEvent(e){this.events.push(e);const t=e.timeStamp/1e3;this.timestamps.push(t);const{x:o,y:r,z:n}=e.acceleration,i=[o,r,n];this.linear_accelerations.push(i)}clearEvents(){this.events=[],this.timestamps=[],this.linear_accelerations=[]}getTimestamp(){return performance.now()/1e3}getLinearAcceleration(){return 0===this.linear_accelerations.length?[0,0,0]:this.linear_accelerations[this.linear_accelerations.length-1]}__reactstandin__regenerateByEval(key,code){this[key]=eval(code)}}!function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default:void 0;e&&e.register(PoseSensor,"PoseSensor","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\PoseSensor.js")}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.leaveModule:void 0;e&&e(module)}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.enterModule:void 0;e&&e(module)}();var __signature__$7="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default.signature:function(e){return e};class IOSPoseSensor extends PoseSensor{constructor(e){super(e),this.fusionSensor=new FusionPoseSensor(.98,.04,!1,this.isDeviceMotionInRadians),this.startTimer()}async onMessage(e){const t=e.data;if(!t||!t.type)return;"devicemotion"===t.type.toLowerCase()&&this.pushDeviceMotionEvent(t.deviceMotionEvent)}onFrame(){var e=this;setImmediate((function(){for(let t=0;t<e.events.length;t++)e.fusionSensor.updateDeviceMotion(e.events[t]);e.updateCallback(),e.clearEvents()})),super.onFrame()}startWithRequestPermisson(){var e=this;return new Promise((function(t){DeviceMotionEvent.requestPermission().then((function(o){"granted"===o&&(window.addEventListener("devicemotion",(function(t){return e.onDeviceMotion(t)})),window.addEventListener("orientationchange",e.onOrientationChange),e.started=!0,t())}))}))}start(){var e=this;return new Promise((function(t,o){setTimeout((function(){e.started?t():o(new Error("not allowed"))}),500),DeviceMotionEvent.requestPermission().then((function(t){"granted"===t&&(window.addEventListener("orientationchange",e.onOrientationChange),window.addEventListener("devicemotion",(function(t){return e.onDeviceMotion(t)})),e.started=!0)}))}))}stop(){this.fusionSensor.stop(),this.fusionSensor=null,window.removeEventListener("message",this.onMessage),window.removeEventListener("devicemotion",this.onDeviceMotion),window.removeEventListener("orientationchange",this.onOrientationChange),this.started=!1}getOrientation(){return this.started?(new Quaternion).fromArray(this.fusionSensor.getOrientation()):new Quaternion}__reactstandin__regenerateByEval(key,code){this[key]=eval(code)}}!function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default:void 0;e&&e.register(IOSPoseSensor,"IOSPoseSensor","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\IOSPoseSensor.js")}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.leaveModule:void 0;e&&e(module)}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.enterModule:void 0;e&&e(module)}();var __signature__$8="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default.signature:function(e){return e};const X_AXIS=new Vector3(1,0,0),Z_AXIS=new Vector3(0,0,1);class ROSPoseSensor extends PoseSensor{constructor(e,t){super(e),_defineProperty(this,"onSensorRead",(function(){})),_defineProperty(this,"onSensorError",(function(e){"NotAllowedError"===e.error.name?console.error("Permission to access sensor was denied"):"NotReadableError"===e.error.name?console.error("Sensor could not be read"):console.error(e.error)})),this.sensor=t,this.sensor_to_world=new Quaternion,this.sensor_to_world.setFromAxisAngle(X_AXIS,-Math.PI/2),this.sensor_to_world.multiply((new Quaternion).setFromAxisAngle(Z_AXIS,Math.PI/2)),this.outQ=new Quaternion,this.sensorQ=new Quaternion,this.counter=0,this.init(),this.startTimer()}init(){this.sensor.addEventListener("reading",this.onSensorRead),this.sensor.start()}onFrame(){}pushDeviceMotionEvent(e){var t=this;super.pushDeviceMotionEvent(e),setImmediate((function(){t.updateCallback(),t.clearEvents(),t.timer=requestAnimationFrame((function(){return t.onFrame()}))}))}start(){var e=this;this.started||(window.addEventListener("devicemotion",(function(t){return e.onDeviceMotion(t)})),window.addEventListener("orientationchange",this.onOrientationChange),this.started=!0)}stop(){this.sensor.removeEventListener("reading",this.onSensorRead),this.sensor.removeEventListener("error",this.onSensorError),this.sensor=null,window.removeEventListener("devicemotion",this.onDeviceMotion),window.removeEventListener("orientationchange",this.onOrientationChange),this.started=!1}getOrientation(){const{sensor_to_world:e,outQ:t,sensorQ:o}=this;if(!this.started)return new Quaternion;const r=this.sensor.quaternion;return r?(o.set(r[0],r[1],r[2],r[3]),t.copy(e),t.multiply(o),t.clone()):new Quaternion}__reactstandin__regenerateByEval(key,code){this[key]=eval(code)}}!function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default:void 0;e&&(e.register(X_AXIS,"X_AXIS","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\ROSPoseSensor.js"),e.register(Z_AXIS,"Z_AXIS","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\ROSPoseSensor.js"),e.register(ROSPoseSensor,"ROSPoseSensor","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\ROSPoseSensor.js"))}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.leaveModule:void 0;e&&e(module)}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.enterModule:void 0;e&&e(module)}();var __signature__$9="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default.signature:function(e){return e};class DMPoseSensor extends PoseSensor{constructor(e){super(e),this.fusionSensor=new FusionPoseSensor(.98,.04,!1,this.isDeviceMotionInRadians),this.startTimer()}onFrame(){}pushDeviceMotionEvent(e){var t=this;super.pushDeviceMotionEvent(e),setImmediate((function(){for(let e=0;e<t.events.length;e++)t.fusionSensor.updateDeviceMotion(t.events[e]);t.updateCallback(),t.clearEvents(),t.timer=requestAnimationFrame((function(){return t.onFrame()}))}))}start(){var e=this;this.started||(window.addEventListener("devicemotion",(function(t){return e.onDeviceMotion(t)})),window.addEventListener("orientationchange",this.onOrientationChange),this.started=!0)}stop(){this.fusionSensor.stop(),this.fusionSensor=null,window.removeEventListener("devicemotion",this.onDeviceMotion),window.removeEventListener("orientationchange",this.onOrientationChange),this.started=!1}getOrientation(){return this.started?(new Quaternion).fromArray(this.fusionSensor.getOrientation()):new Quaternion}__reactstandin__regenerateByEval(key,code){this[key]=eval(code)}}!function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default:void 0;e&&e.register(DMPoseSensor,"DMPoseSensor","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\DMPoseSensor.js")}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.leaveModule:void 0;e&&e(module)}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.enterModule:void 0;e&&e(module)}();var __signature__$a="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default.signature:function(e){return e};class NoIMUPoseSensor extends PoseSensor{constructor(e){var t;super(e),t=this,_defineProperty(this,"onFrame",(function(){t.updateCallback(),t.timer=requestAnimationFrame(t.onFrame)})),this.startTimer()}startTimer(){this.timer=requestAnimationFrame(this.onFrame)}clearTimer(){cancelAnimationFrame(this.timer)}start(){this.started||(this.started=!0)}stop(){this.started=!1}getOrientation(){return new Quaternion}__reactstandin__regenerateByEval(key,code){this[key]=eval(code)}}!function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default:void 0;e&&e.register(NoIMUPoseSensor,"NoIMUPoseSensor","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\NoIMUPoseSensor.js")}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.leaveModule:void 0;e&&e(module)}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.enterModule:void 0;e&&e(module)}();var __signature__$b="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default.signature:function(e){return e};class PoseSensorSelector{constructor(e){_defineProperty(this,"onSensorError",(function(e){})),this.pose_sensor=null;if(isIOS()|isAndroid())if(isIOS())this.pose_sensor=new IOSPoseSensor(e);else{const t=this.tryInitRelativeOrientationSensor();this.pose_sensor=t?new ROSPoseSensor(e,t):new DMPoseSensor(e)}else this.pose_sensor=new NoIMUPoseSensor(e)}getTimestamp(){return this.pose_sensor.getTimestamp()}getOrientation(){return this.pose_sensor.getOrientation()}getLinearAcceleration(){return this.pose_sensor.getLinearAcceleration()}on(e,t){this.pose_sensor.on(e,t)}startWithRequestPermisson(){return this.pose_sensor.startWithRequestPermisson()}start(){return this.pose_sensor.start()}isStarted(){return this.pose_sensor.started}tryInitRelativeOrientationSensor(){let e=null;try{e=new RelativeOrientationSensor({frequency:30,referenceFrame:"screen"}),e.addEventListener("error",this.onSensorError)}catch(t){"SENSOR_FREQUENCY"===t.name?(console.log("Cannot construct sensors due to the Feature Policy"),e=null):("ReferenceError"===t.name||console.error(t),e=null)}return e}__reactstandin__regenerateByEval(key,code){this[key]=eval(code)}}!function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default:void 0;e&&e.register(PoseSensorSelector,"PoseSensorSelector","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\imu\\PoseSensorSelector.js")}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.leaveModule:void 0;e&&e(module)}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.enterModule:void 0;e&&e(module)}();var __signature__$c="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default.signature:function(e){return e};const MIN_DIST=10,MAX_CNT=500,MAX_ROT_RATE=90,USE_KEYFRAMES=1,USE_WARPING=0,USE_IMAGE_FILTER=1,USE_PREDICTION=1;!function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default:void 0;e&&(e.register(MIN_DIST,"MIN_DIST","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\slam\\parameters.js"),e.register(MAX_CNT,"MAX_CNT","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\slam\\parameters.js"),e.register(MAX_ROT_RATE,"MAX_ROT_RATE","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\slam\\parameters.js"),e.register(USE_KEYFRAMES,"USE_KEYFRAMES","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\slam\\parameters.js"),e.register(USE_WARPING,"USE_WARPING","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\slam\\parameters.js"),e.register(USE_IMAGE_FILTER,"USE_IMAGE_FILTER","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\slam\\parameters.js"),e.register(USE_PREDICTION,"USE_PREDICTION","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\slam\\parameters.js"))}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.leaveModule:void 0;e&&e(module)}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.enterModule:void 0;e&&e(module)}();var __signature__$d="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default.signature:function(e){return e};class CVSlam{constructor(){this.slam=null}init(e,t,o,r,n,i,a,s){this.slam=new cv.SLAM(e,t,o,r,n,i,a,s)}compute(e,t,o,r,n,i,a){let s=cv.matFromArray(4,1,cv.CV_64F,t.toArray()),l=cv.matFromArray(3,1,cv.CV_64F,o),c=new cv.Mat;this.slam.compute(e,s,l,r,n,i,c);for(let e=0;e<c.data64F.length;e++)a[e]=c.data64F[e]}start(e,t){return this.slam.start(e,t)}clear(){this.slam.clear()}getImageFrame(e){this.slam.getImageFrame(e)}getDebug(e,t,o,r,n,i){let a=new cv.Mat,s=new cv.Mat,l=new cv.Mat,c=new cv.Mat;const d=this.slam.getDebug(e,t,a,s,l,c);a.data64F.length;return d}__reactstandin__regenerateByEval(key,code){this[key]=eval(code)}}!function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default:void 0;e&&e.register(CVSlam,"CVSlam","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\slam\\CVSlam.js")}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.leaveModule:void 0;e&&e(module)}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.enterModule:void 0;e&&e(module)}();var __signature__$e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default.signature:function(e){return e};const DEFAULT_SETTINGS$1={debug:!1};class Estimator{constructor(e,t,o=60,r={}){var n=this;_defineProperty(this,"process",(function(){const e=n.poseSensor.getOrientation(),t=n.poseSensor.getTimestamp(),o=n.poseSensor.getLinearAcceleration();if(n.capture.read(n.image),n.slam.compute(n.image,e,o,n.video_canvas.width,n.video_canvas.height,t,n.translation),n.slam.getImageFrame(n.cur_image_frame),n.settings.debug){n.features=[];const e=[],t=[],r=[],i=n.slam.getDebug(n.prev_image,n.cur_image,n.features,e,t,r);console.log("VIS Q: "+e[0]+" "+e[1]+" "+e[2]+" "+e[3]),console.log("VIS T: "+t[0]+" "+t[1]+" "+t[2]),console.log("angular_velocity: "+angular_velocity[0]+" "+angular_velocity[1]+" "+angular_velocity[2]),console.log("linear_acceleration: "+o[0]+" "+o[1]+" "+o[2]),console.log("IMU T: "+r[0]+" "+r[1]+" "+r[2]),console.log("dt: "+i)}cv.imshow(n.video_canvas.id,n.cur_image_frame),n.emit("update",n.translation)})),this.video=e,this.video_canvas=t,this.fov=o,this.video.width=this.video.videoWidth,this.video.height=this.video.videoHeight,this.settings={...DEFAULT_SETTINGS$1,...r};const{emit:i,on:a,off:s}=_default(this);this.emit=i,this.on=a,this.off=s,this.poseSensor=null,this.image=null,this.cur_image_frame=new cv.Mat,this.prev_image=new cv.Mat,this.cur_image=new cv.Mat,this.features=[],this.translation=[],this.capture=null,this.video_mat=new cv.Mat,this.isIOS=isIOS(),this.slam=new CVSlam,this.init()}init(){var e=this;this.initSLAM().then((function(){return e.initIMU()})).then((function(){return e.initVideoCapture()})).then((function(){return e.poseSensor.start()})).then((function(){e.emit("ready")}),(function(t){e.emit("permission-request")}))}initSLAM(){var e=this;return new Promise((function(t){e.slam.init(MAX_CNT,MIN_DIST,e.fov,MAX_ROT_RATE,USE_KEYFRAMES,USE_WARPING,USE_IMAGE_FILTER,USE_PREDICTION),t()}))}initIMU(){var e=this;return new Promise((function(t){e.poseSensor&&(e.poseSensor.stop(),e.poseSensor=null),e.poseSensor=new PoseSensorSelector(e.process),t()}))}initVideoCapture(){var e=this;return new Promise((function(t){e.capture=new cv.VideoCapture(e.video),e.image=new cv.Mat(e.video.videoHeight,e.video.videoWidth,cv.CV_8UC4),t()}))}startImu(){this.emit("ready"),this.poseSensor.startWithRequestPermisson()}start(e,t){var o=this;return new Promise((function(r,n){o.poseSensor.isStarted()&&(o.slam.start(e,t)?r():n(new Error("Wrong location!!!")))}))}getQueryPoints(){return this.features}clear(){this.translation=[],this.slam.clear()}__reactstandin__regenerateByEval(key,code){this[key]=eval(code)}}!function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default:void 0;e&&(e.register(DEFAULT_SETTINGS$1,"DEFAULT_SETTINGS","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\slam\\Estimator.js"),e.register(Estimator,"Estimator","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\slam\\Estimator.js"))}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.leaveModule:void 0;e&&e(module)}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.enterModule:void 0;e&&e(module)}();var __signature__$f="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default.signature:function(e){return e};const DEFAULT_SETTINGS$2={type:"default",debug:!1};class Slam{constructor(e){var t=this;_defineProperty(this,"onEstimatorUpdate",(function(e){t.emit("geenee-slam-update",e)})),_defineProperty(this,"onEstimatorReady",(function(){t.emit("geenee-slam-ready")})),_defineProperty(this,"onEstimatorPermissionRequest",(function(){t.emit("geenee-slam-permission-request")}));const{emit:o,on:r,off:n}=_default(this);return this.emit=o,this.on=r,this.off=n,e.slam_instance=this,this.supports_imu=isIOS()|isAndroid(),this.loadOpenCV()}loadOpenCV(){return new Promise((function(e){global.Module={onRuntimeInitialized:e},global.cv=require("@geenee/geenee-slam-impl")}))}init(e,t,o){this.width=e.videoWidth,this.height=e.videoHeight,this.settings=DEFAULT_SETTINGS$2;const r={...DEFAULT_SETTINGS$2};this.estimator=new Estimator(e,t,o,r),this.estimator.on("update",this.onEstimatorUpdate),this.estimator.on("ready",this.onEstimatorReady),this.estimator.on("permission-request",this.onEstimatorPermissionRequest)}startImu(){this.estimator.startImu()}start(e,t){return this.estimator.start(e,t)}stop(){}__reactstandin__regenerateByEval(key,code){this[key]=eval(code)}}!function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default:void 0;e&&(e.register(DEFAULT_SETTINGS$2,"DEFAULT_SETTINGS","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\Slam.js"),e.register(Slam,"Slam","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\Slam.js"))}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.leaveModule:void 0;e&&e(module)}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.enterModule:void 0;e&&e(module)}();var __signature__$g="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default.signature:function(e){return e};function loadSLAM(){return new Slam(window)}function initSLAM(e,t,o){window.slam_instance.init(e,t,o)}function startImuSLAM(){window.slam_instance.startImu()}function startSLAM(e,t){return window.slam_instance.start(e,t)}function stopSLAM(){window.slam_instance.stop()}function onSLAM(e,t){window.slam_instance.on(e,t)}function getQueryPoints(){return window.slam_instance.estimator.getQueryPoints()}!function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default:void 0;e&&(e.register(loadSLAM,"loadSLAM","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\slam-sdk.js"),e.register(initSLAM,"initSLAM","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\slam-sdk.js"),e.register(startImuSLAM,"startImuSLAM","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\slam-sdk.js"),e.register(startSLAM,"startSLAM","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\slam-sdk.js"),e.register(stopSLAM,"stopSLAM","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\slam-sdk.js"),e.register(onSLAM,"onSLAM","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\slam-sdk.js"),e.register(getQueryPoints,"getQueryPoints","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\slam-sdk.js"))}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.leaveModule:void 0;e&&e(module)}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.enterModule:void 0;e&&e(module)}();var __signature__$h="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default.signature:function(e){return e};const GeeneeSLAM={load:loadSLAM,init:initSLAM,startImu:startImuSLAM,start:startSLAM,stop:stopSLAM,on:onSLAM};window.GeeneeSLAM=GeeneeSLAM;const _default$1=GeeneeSLAM;!function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default:void 0;e&&(e.register(GeeneeSLAM,"GeeneeSLAM","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\index.js"),e.register(_default$1,"default","d:\\Workspaces\\react\\GeeneeSDK\\packages\\slam\\src\\index.js"))}(),function(){var e="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.leaveModule:void 0;e&&e(module)}();export default _default$1;
